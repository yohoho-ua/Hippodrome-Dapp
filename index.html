<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <link rel="stylesheet" type="text/css" href="main.css">

	<script src="./node_modules/web3/dist/web3.min.js"></script>
	<script src="properties.js"></script>

</head>
<body>
<div class="container">

	<h1>Hippodrome</h1> 
	<select id="select">
			<option value="0">account 1</option>
			<option value="1">account 2</option>
			<option value="2">account 3</option>
		  </select>

    <table align="left" width="120" border="1">
        <tbody>
        <tr>
            <td>Storm</td>
            <td>Wind</td>
            <td>Speedy</td>
            <td>Winner</td>
			<td>Cutie</td>
        </tr>
        <tr>
            <td><img src="images/unicorn.jpg" width="200" height="119" alt=""/></td>
            <td><img src="images/grey.jpg" width="200" height="119" alt=""/></td>
            <td><img src="images/brown.jpg" width="200" height="119" alt=""/></td>
            <td><img src="images/white.jpg" width="200" height="119" alt=""/></td>
            <td><img src="images/black.jpg" width="200" height="119" alt=""/></td>
        </tr>
        <tr>
            <td>1</td>
            <td>2</td>
            <td>3</td>
            <td>4</td>
            <td>5</td>
        </tr>
        <tr>
        <td><p id="horse1" class="horse_number"></p></td>
        <td><p id="horse2" class="horse_number"></p></td>
        <td><p id="horse3" class="horse_number"></p></td>
        <td><p id="horse4" class="horse_number"></p></td>
        <td><p id="horse5" class="horse_number"></p></td>
        </tr>
        </tbody>
    </table>
    <!--<img id="loader" src="https://loading.io/spinners/double-ring/lg.double-ring-spinner.gif">-->
    <h1 id="error" hidden>Error!</h1>
    <h1 id="winner" hidden></h1>


    <div>
        <label for="horseNumber">Select horse</label>
        <input id="horseNumber" type="text">
        <button id="buttonBet">Bet!</button>
    </div>
    <div><label for="maxBetInput">Set max amount of bets </label>
        <input id="maxBetInput" type="text">


        <button id="buttonTest">Set Max bet</button>
    </div>
    <p id="minimumBet">Minimum Bet: </p>
    <p id="totalBet">Total Bet: </p>
    <p id="numberOfBets">Number of Bets: </p>
    <p id="maxAmountOfBets">Max amount of bets:  </p>
    <p id="acc"></p>
    <p id="raceId"></p>
</div>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

<script>
	//only for test for fast switching accounts
	var currentPlayer = 0;
	$(document).ready(function(){
	$("#select" ).on('change', function() { 
	currentPlayer = $(this).val();
	web3.eth.defaultAccount = web3.eth.accounts[currentPlayer]
  	})
	});
	

    if (typeof web3 !== 'undefined') {
        web3 = new Web3(web3.currentProvider);
    } else {
        // set the provider you want from Web3.providers
        web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    }
    web3.eth.defaultAccount = web3.eth.accounts[currentPlayer];
    // web3.eth.defaultAccount =  window.web3.eth.defaultAccount;
   { var HippoContract = web3.eth.contract(gOptions.abi);
   }
    // var Hippo = HippoContract.at('0xa8f3e0b7b5365b10417b29d631cb1b6e830edb08');
    var Hippo = HippoContract.at(gOptions.address);

    console.log(Hippo);

	var hippoEvent = Hippo.hippoEvent({},'latest');
	var resultsEvent = Hippo.results({},'latest');
	/* 
        Hippo.minimumBet(function(error, result){
            if(!error)
                {
                    $("#minimumBet").html("Minimum Bet: " + result);
                    console.log("result: " + result);
                }
            else
                console.error(error);
        });
        Hippo.totalBet(function(error, result){
            if(!error)
                {
                    $("#totalBet").html("Total Bet: " + result);
                    console.log("result: " + result);
                }
            else
                console.error(error);
        });
        Hippo.numberOfBets(function(error, result){
            if(!error)
                {
                    $("#numberOfBets").html("Number of Bets: " + result);
                    console.log("result: " + result);
                }
            else
                console.error(error);
        });
        Hippo.maxAmountOfBets(function(error, result){
            if(!error)
                {
                    $("#maxAmountOfBets").html("Max amount of Bets: " + result);
                    console.log("result: " + result);
                }
            else
                console.error(error);
        });
 */
    Hippo.getSelectedHorses(function(error, result){
        if(!error) {
            for (var i=0; i<5; i++) {
                $("#horse"+(i+1)).html("Horse was selected " + result[i] +" times");
                console.log("horse "+i +" was shown")
            }
        }
        else{
            console.log("horse error")
        }
    });

    hippoEvent.watch(function(error, result){
        if (!error)
        {  console.log("hippoEvent");
            $("#loader").hide();
            $("#minimumBet").html("Minimum Bet: " + result.args.minimumBet);
            $("#totalBet").html("Total Bet: " +  web3.fromWei(result.args.totalBet, 'ether') + " Eth.");
            $("#numberOfBets").html("Number of Bets: " + result.args.numberOfBets);
            $("#maxAmountOfBets").html("Max amount of Bets: " + result.args.maxAmountOfBets);
			$("#acc").html("Current account: " + web3.eth.defaultAccount);
            $("#horse"+$("#horseNumber").val()).html("Horse was selected "+ result.args.numberOfSelections);
            $("#raceId").html("Current race id: " + result.args.raceId);
        } else {
            console.log(error);
        }
	});

	resultsEvent.watch(function(error, result){
        if (!error)
        {  console.log("resultsEvent");
            $("#winner").show();
            $("#winner").html("Race id [" + result.args.raceId + "] winner is horse number - " + result.args.horseWinner);
        } else {
            console.log(error);
        }
	});
	

   /*  var maxInputsEvent = Hippo.maxInputs({},'latest');
    maxInputsEvent.watch(function(error, result){
        if (!error)
        {  console.log("bla bla");
            $("#loader").hide();
            // $("#minimumBet").html("minimumBet:" + result.args.minimumBet);
            // $("#totalBet").html("totalBet:" + result.args.totalBet);
            // $("#numberOfBets").html("numberOfBets:" + result.args.numberOfBets);
            $("#maxAmountOfBets").html("maxAmountOfBets:" + result.args.maxAmountOfBets);
              $("#acc").html("current account:" + web3.eth.defaultAccount);
        } else {
            $("#loader").hide();
            console.log(error);
        }
    }); */


    $("#buttonBet").click(function() {
		$("#loader").show();
		$("#winner").hide();
        try {
        Hippo.bet($("#horseNumber").val(), {
            gas: 300000,
            from: web3.eth.defaultAccount,
            value: web3.toWei(1, 'ether')
        });}
        catch (error){
            $("#loader").hide();

            $("#error").html("Error!!");
            alert("You have made your bet!");
            console.log("Error!!Please wait to a prize drawing!");
        }
    });

    $("#buttonTest").click(function() {
		$("#winner").hide();
        Hippo.setMaxAmountOfBets($("#maxBetInput").val(), {
        });
    });

</script>

</body>
</html>